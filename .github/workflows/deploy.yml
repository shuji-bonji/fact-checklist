# .github/workflows/deploy.yml
name: Vercel Deploy and Quality Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆå¿…è¦æœ€å°é™ï¼‰
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Gitå±¥æ­´ã‚’å…¨ã¦å–å¾—ï¼ˆlastmodç”¨ï¼‰

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run check

      - name: Lint check
        run: npm run lint

      - name: Build test (for verification)
        run: npm run build

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ï¼ˆæƒ…å ±æä¾›ã®ã¿ï¼‰
  security-audit:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Gitå±¥æ­´ã‚’å…¨ã¦å–å¾—ï¼ˆlastmodç”¨ï¼‰

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: |
          echo "ðŸ”’ Running security audit..."
          npm audit --audit-level=moderate || echo "Vulnerabilities found (non-blocking)"

  # Vercel ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  vercel-deploy:
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Gitå±¥æ­´ã‚’å…¨ã¦å–å¾—ï¼ˆlastmodç”¨ï¼‰

      - name: Deploy to Vercel
        run: |
          echo "ðŸš€ Deploying to Vercel..."
          echo "Vercel handles the build and deployment automatically"
          echo "âœ… Deployment triggered successfully!"

  # PR ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  pr-feedback:
    runs-on: ubuntu-latest
    needs: [quality-gate, security-audit]
    if: github.event_name == 'pull_request'
    steps:
      - name: PR Quality Report
        run: |
          echo "## ðŸš€ PR Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Test | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | âš ï¸ Advisory |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready for deployment to Vercel! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
