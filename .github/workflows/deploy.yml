# .github/workflows/deploy.yml
name: Build and Deploy to GitHub Pages

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  schedule:
    - cron: '0 9 * * 1' # æ¯é€±æœˆæ›œæ—¥9æ™‚ï¼ˆJST 18æ™‚ï¼‰ã«Lighthouseå®Ÿè¡Œ
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  # å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆã‚²ãƒ¼ãƒˆï¼‰
  quality-gate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate .svelte-kit
        run: npm exec svelte-kit sync

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run check

      - name: Run tests (if available)
        run: npm test --if-present

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        if: matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build/
          retention-days: 1

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
  security-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level=moderate

          # é«˜å±é™ºåº¦ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
          HIGH_VULNS=$(npm audit --audit-level=high --json 2>/dev/null | jq '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "âŒ High severity vulnerabilities found: $HIGH_VULNS"
            echo "Please run 'npm audit fix' to resolve"
            exit 1
          fi
          echo "âœ… No high severity vulnerabilities found"

  # Lighthouseç›£æŸ»ï¼ˆPRæ™‚ + é€±æ¬¡ï¼‰
  lighthouse-audit:
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: build/

      - name: Check build directory
        run: |
          echo "Build directory contents:"
          ls -la build/
          find build/ -name "*.html" -type f

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

  # ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy:
    runs-on: ubuntu-latest
    needs: [quality-gate, security-audit]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate sitemap and update PWA version
        run: |
          npm run generate:sitemap
          npm run update:pwa-version

      - name: Commit updated files (if changed)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -n "$(git status --porcelain)" ]; then
            git add static/sitemap.xml
            git commit -m "Auto-update: sitemap.xml and PWA version [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
        continue-on-error: true

      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production
          GITHUB_PAGES: true

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment notification
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Live at: https://shuji-bonji.github.io/fact-checklist/"
          echo "ğŸ“Š Commit: ${{ github.sha }}"

  # PRå“è³ªãƒ¬ãƒãƒ¼ãƒˆï¼ˆPRæ™‚ã®ã¿ï¼‰
  pr-feedback:
    runs-on: ubuntu-latest
    needs: [quality-gate, security-audit, lighthouse-audit]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Generate PR report
        uses: actions/github-script@v7
        with:
          script: |
            const qualityStatus = '${{ needs.quality-gate.result }}';
            const securityStatus = '${{ needs.security-audit.result }}';
            const lighthouseStatus = '${{ needs.lighthouse-audit.result }}';

            const statusEmoji = {
              'success': 'âœ…',
              'failure': 'âŒ',
              'cancelled': 'âš ï¸',
              'skipped': 'â­ï¸'
            };

            const comment = `## ğŸš€ PRå“è³ªãƒã‚§ãƒƒã‚¯çµæœ

            | ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |
            |-------------|------|
            | å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆLint/Type/Buildï¼‰ | ${statusEmoji[qualityStatus] || 'â“'} ${qualityStatus} |
            | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ» | ${statusEmoji[securityStatus] || 'â“'} ${securityStatus} |
            | Lighthouse | ${statusEmoji[lighthouseStatus] || 'â“'} ${lighthouseStatus} |

            ${qualityStatus === 'success' && securityStatus === 'success' 
              ? 'âœ… **å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¾ã—ãŸï¼ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚**' 
              : 'âŒ **å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚ä¿®æ­£å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚**'
            }

            ${lighthouseStatus === 'failure' ? 
              '\nâš ï¸ Lighthouseã§æ”¹å–„ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€ãƒãƒ¼ã‚¸ã¯å¯èƒ½ã§ã™ã€‚' : 
              ''
            }
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  # é€±æ¬¡Lighthouseãƒ¬ãƒãƒ¼ãƒˆ
  lighthouse-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Create weekly report issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `ğŸ“Š é€±æ¬¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ (${date})`;

            const body = `## ğŸ“Š é€±æ¬¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£æŸ»çµæœ

            ã“ã® issue ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

            ### Lighthouseã‚¹ã‚³ã‚¢
            - Actions ã‚¿ãƒ–ã® Lighthouse çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„
            - å‰å›ã¨ã®æ¯”è¼ƒã§å¤§ããªå¤‰åŒ–ãŒã‚ã‚Œã°å¯¾å¿œã‚’æ¤œè¨

            ### ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
            - [ ] Performance ã‚¹ã‚³ã‚¢ã®ç¢ºèª
            - [ ] Accessibility ã‚¹ã‚³ã‚¢ã®ç¢ºèª  
            - [ ] Best Practices ã‚¹ã‚³ã‚¢ã®ç¢ºèª
            - [ ] SEO ã‚¹ã‚³ã‚¢ã®ç¢ºèª

            ### æ”¹å–„ãŒå¿…è¦ãªå ´åˆ
            1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ã®åŸå› èª¿æŸ»
            2. æ”¹å–„æ–½ç­–ã®æ¤œè¨ãƒ»å®Ÿè£…
            3. æ¬¡å›ç›£æŸ»ã§ã®ç¢ºèª

            *ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯æ¯é€±æœˆæ›œæ—¥ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['lighthouse', 'performance', 'weekly-report']
            });
