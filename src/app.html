<!doctype html>
<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<!-- アクセシビリティ改善：user-scalable=noを削除、maximum-scale=5に設定 -->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

		<!-- Content Security Policy（セキュリティ強化） -->
		<meta
			http-equiv="Content-Security-Policy"
			content="
			default-src 'self';
			script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://cdnjs.cloudflare.com;
			style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
			font-src 'self' https://fonts.gstatic.com data:;
			img-src 'self' data: blob: https:;
			connect-src 'self' blob:;
			object-src 'none';
			base-uri 'self';
			form-action 'self';
			upgrade-insecure-requests;
		"
		/>

		<meta
			name="description"
			content="情報の信頼性を科学的・体系的に評価するための実用的事実確認チェックシート。PWA対応でオフラインでも利用可能。"
		/>
		<meta name="keywords" content="事実確認,ファクトチェック,情報検証,信頼性評価,PWA,オフライン" />
		<meta name="author" content="Fact Checklist Team" />
		<meta name="robots" content="index, follow" />

		<!-- PWA用メタタグ -->
		<meta name="application-name" content="実用的事実確認チェックシート" />
		<meta name="theme-color" content="#2c3e50" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="default" />
		<meta name="apple-mobile-web-app-title" content="事実確認チェックシート" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="msapplication-TileColor" content="#2c3e50" />
		<meta name="msapplication-tap-highlight" content="no" />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://shuji-bonji.github.io/fact-checklist/" />
		<meta property="og:title" content="実用的事実確認チェックシート" />
		<meta property="og:description" content="情報の信頼性を科学的・体系的に評価するためのPWA" />
		<meta property="og:image" content="https://shuji-bonji.github.io/fact-checklist/og-image.png" />
		<meta property="og:locale" content="ja_JP" />
		<meta property="og:site_name" content="実用的事実確認チェックシート" />

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content="https://shuji-bonji.github.io/fact-checklist/" />
		<meta property="twitter:title" content="実用的事実確認チェックシート" />
		<meta
			property="twitter:description"
			content="情報の信頼性を科学的・体系的に評価するためのPWA"
		/>
		<meta
			property="twitter:image"
			content="https://shuji-bonji.github.io/fact-checklist/og-image.png"
		/>

		<!-- アイコン（VitePWAが manifest を自動管理） -->
		<link rel="icon" href="%sveltekit.assets%/favicon.png" />
		<link rel="icon" type="image/svg+xml" href="%sveltekit.assets%/icon.svg" />
		<link rel="apple-touch-icon" href="%sveltekit.assets%/apple-touch-icon.png" />
		<!-- manifest linkはVitePWAが自動挿入するため削除 -->

		<!-- フォントの事前読み込み -->
		<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

		<!-- セキュリティヘッダー -->
		<meta http-equiv="X-Content-Type-Options" content="nosniff" />
		<meta http-equiv="X-Frame-Options" content="DENY" />
		<meta http-equiv="X-XSS-Protection" content="1; mode=block" />
		<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
		<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()" />

		<!-- DNS Prefetch -->
		<link rel="dns-prefetch" href="//fonts.googleapis.com" />
		<link rel="dns-prefetch" href="//fonts.gstatic.com" />

		<!-- JSON-LD構造化データ -->
		<script type="application/ld+json">
			{
				"@context": "https://schema.org",
				"@type": "WebApplication",
				"name": "実用的事実確認チェックシート",
				"description": "情報の信頼性を科学的・体系的に評価するためのPWA",
				"url": "https://shuji-bonji.github.io/fact-checklist/",
				"applicationCategory": "EducationalApplication",
				"operatingSystem": "Any",
				"permissions": "browser",
				"offers": {
					"@type": "Offer",
					"price": "0",
					"priceCurrency": "JPY"
				},
				"author": {
					"@type": "Organization",
					"name": "Fact Checklist Team"
				},
				"inLanguage": "ja-JP",
				"browserRequirements": "Requires JavaScript. Requires HTML5.",
				"softwareVersion": "1.0.0",
				"aggregateRating": {
					"@type": "AggregateRating",
					"ratingValue": "5",
					"ratingCount": "1"
				}
			}
		</script>

		<title>%sveltekit.title%</title>

		<!-- インラインCSS（重要なスタイルの先読み） -->
		<style>
			/* Critical CSS for faster loading */
			body {
				margin: 0;
				padding: 0;
				font-family:
					'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', system-ui, sans-serif;
				line-height: 1.6;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				color: #2c3e50;
				/* タッチ操作の改善 */
				touch-action: pan-x pan-y;
				/* iOS Safariでのタップハイライトを削除 */
				-webkit-tap-highlight-color: transparent;
			}

			/* Loading spinner - アクセシブルなデザイン */
			.app-loading {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				min-height: 100vh;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				z-index: 9999;
			}

			.spinner {
				width: 40px;
				height: 40px;
				border: 4px solid rgba(255, 255, 255, 0.3);
				border-top: 4px solid white;
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin-bottom: 20px;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.loading-text {
				font-size: 1.1em;
				opacity: 0.9;
			}

			/* アプリ読み込み完了時にローディング画面を非表示 */
			body.app-loaded .app-loading {
				display: none;
			}

			/* フォーカス管理の改善 */
			:focus-visible {
				outline: 3px solid #3498db;
				outline-offset: 2px;
			}

			/* ダークモード対応 */
			@media (prefers-color-scheme: dark) {
				:root {
					color-scheme: dark;
				}
			}

			/* 縮小されたモーション対応 */
			@media (prefers-reduced-motion: reduce) {
				.spinner {
					animation: none;
				}

				*,
				*::before,
				*::after {
					animation-duration: 0.01ms !important;
					animation-iteration-count: 1 !important;
					transition-duration: 0.01ms !important;
				}
			}
		</style>

		%sveltekit.head%
	</head>
	<body data-sveltekit-preload-data="hover">
		<!-- NoScript fallback -->
		<noscript>
			<div
				style="
					display: flex;
					flex-direction: column;
					align-items: center;
					justify-content: center;
					min-height: 100vh;
					padding: 20px;
					text-align: center;
					background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
					color: white;
					font-family: system-ui, sans-serif;
				"
			>
				<h1>⚠️ JavaScript が必要です</h1>
				<p>このアプリケーションを使用するには、ブラウザでJavaScriptを有効にしてください。</p>
				<p style="margin-top: 20px; opacity: 0.8">
					<strong>実用的事実確認チェックシート</strong><br />
					情報の信頼性を評価するためのツールです
				</p>
			</div>
		</noscript>

		<!-- Loading screen -->
		<div class="app-loading" role="status" aria-label="アプリケーション読み込み中">
			<div class="spinner" aria-hidden="true"></div>
			<div class="loading-text">読み込み中...</div>
		</div>

		<!-- App content -->
		<div style="display: contents">%sveltekit.body%</div>

		<!-- PWA install prompt helper -->
		<script>
			// エラー処理の改善
			function logError(message, error) {
				console.error(message, error);
				// 本番環境では分析サービスにエラーを送信
				// if (!location.hostname.includes('localhost')) {
				//     sendErrorToAnalytics(message, error);
				// }
			}

			// ローディング画面を非表示にする
			function hideLoadingScreen() {
				try {
					document.body.classList.add('app-loaded');
					const loadingElement = document.querySelector('.app-loading');
					if (loadingElement && loadingElement instanceof HTMLElement) {
						loadingElement.style.display = 'none';
						console.log('Loading screen hidden');
					}
				} catch (error) {
					logError('Error hiding loading screen:', error);
				}
			}

			// DOMContentLoadedでローディング画面を非表示
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', hideLoadingScreen);
			} else {
				hideLoadingScreen();
			}

			// アプリの初期化完了後にも確実に非表示にする
			setTimeout(hideLoadingScreen, 100);

			// ウィンドウの読み込み完了後にも確認
			window.addEventListener('load', hideLoadingScreen);

			// PWAインストールプロンプト用のイベントハンドラ
			let deferredPrompt;

			window.addEventListener('beforeinstallprompt', e => {
				console.log('PWA install prompt available');
				e.preventDefault();
				deferredPrompt = e;

				// カスタムインストールボタンを表示する場合
				const installButton = document.querySelector('#pwa-install-button');
				if (installButton) {
					installButton.style.display = 'block';
					installButton.addEventListener('click', () => {
						if (deferredPrompt) {
							deferredPrompt.prompt();
							deferredPrompt.userChoice.then(choiceResult => {
								if (choiceResult.outcome === 'accepted') {
									console.log('User accepted PWA install');
								} else {
									console.log('User dismissed PWA install');
								}
								deferredPrompt = null;
								installButton.style.display = 'none';
							});
						}
					});
				}
			});

			window.addEventListener('appinstalled', e => {
				console.log('PWA was installed');
				const installButton = document.querySelector('#pwa-install-button');
				if (installButton) {
					installButton.style.display = 'none';
				}
			});

			// Service Worker の更新通知（改善版）
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.addEventListener('controllerchange', () => {
					console.log('Service Worker updated, reloading...');
					window.location.reload();
				});

				// Service Worker登録エラーのキャッチ
				navigator.serviceWorker.ready.catch(error => {
					logError('Service Worker registration failed:', error);
				});
			}
		</script>

		<!-- Global error handler - 改善版 -->
		<script>
			window.addEventListener('error', e => {
				logError('Global error:', e.error);
			});

			window.addEventListener('unhandledrejection', e => {
				logError('Unhandled promise rejection:', e.reason);
				// プロミスリジェクションを処理済みとしてマーク
				e.preventDefault();
			});
		</script>

		<!-- Performance monitoring - Core Web Vitals -->
		<script>
			if ('PerformanceObserver' in window) {
				try {
					// LCP (Largest Contentful Paint)
					new PerformanceObserver(list => {
						const entries = list.getEntries();
						const lastEntry = entries[entries.length - 1];
						console.log('LCP:', lastEntry.startTime);
					}).observe({ entryTypes: ['largest-contentful-paint'] });

					// FID (First Input Delay)
					new PerformanceObserver(list => {
						list.getEntries().forEach(entry => {
							console.log('FID:', entry.processingStart - entry.startTime);
						});
					}).observe({ entryTypes: ['first-input'] });

					// CLS (Cumulative Layout Shift)
					new PerformanceObserver(list => {
						let clsValue = 0;
						list.getEntries().forEach(entry => {
							if (!entry.hadRecentInput) {
								clsValue += entry.value;
							}
						});
						console.log('CLS:', clsValue);
					}).observe({ entryTypes: ['layout-shift'] });
				} catch (error) {
					logError('Performance monitoring error:', error);
				}
			}
		</script>
	</body>
</html>
